(function($){$.fn.hasAttr=function(name){return this.attr(name)!==undefined}}(jQuery));function ModalRemote(modalId){this.defaults={okLabel:"确 定",executeLabel:"Execute",cancelLabel:"取 消",loadingTitle:"努力加载中..."};this.modal=$(modalId);this.dialog=$(modalId).find('.modal-dialog');this.header=$(modalId).find('.modal-header');this.content=$(modalId).find('.modal-body');this.footer=$(modalId).find('.modal-footer');this.loadingContent='<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>';this.show=function(){this.clear();$(this.modal).modal('show')};this.hide=function(){$(this.modal).modal('hide')};this.toggle=function(){$(this.modal).modal('toggle')};this.clear=function(){$(this.modal).find('.modal-title').remove();$(this.content).html("");$(this.footer).html("")};this.setSize=function(size){$(this.dialog).removeClass('modal-lg');$(this.dialog).removeClass('modal-sm');if(size=='large')$(this.dialog).addClass('modal-lg');else if(size=='small')$(this.dialog).addClass('modal-sm');else if(size!=='normal')console.warn("Undefined size "+size)};this.setHeader=function(content){$(this.header).html(content)};this.setContent=function(content){$(this.content).html(content)};this.setFooter=function(content){$(this.footer).html(content)};this.setTitle=function(title){$(this.header).find('h4.modal-title').remove();$(this.header).append('<h4 class="modal-title text-center">'+title+'</h4>')};this.hidenCloseButton=function(){$(this.header).find('button.close').hide()};this.showCloseButton=function(){$(this.header).find('button.close').show()};this.displayLoading=function(){this.setContent(this.loadingContent);this.setTitle(this.defaults.loadingTitle)};this.addFooterButton=function(label,type,classes,callback){buttonElm=document.createElement('button');buttonElm.setAttribute('type',type===null?'button':type);buttonElm.setAttribute('class',classes===null?'btn btn-primary':classes);buttonElm.innerHTML=label;var instance=this;$(this.footer).append(buttonElm);if(callback!==null){$(buttonElm).click(function(event){callback.call(instance,this,event)})}};this.doRemote=function(url,method,data){var instance=this;$.ajax({url:url,method:method,data:data,async:false,beforeSend:function(){beforeRemoteRequest.call(instance)},error:function(response){errorRemoteResponse.call(instance,response)},success:function(response){successRemoteResponse.call(instance,response)},contentType:false,cache:false,processData:false})};function beforeRemoteRequest(){this.show();this.displayLoading()}function errorRemoteResponse(response){var that=this;setTimeout(function(){that.hide();if(localStorage.getItem("show-message")=='1'){swal({title:"系统异常",text:'系统服务异常，请稍后再试!',type:"warning",confirmButtonColor:localStorage.getItem("s-skin-color"),confirmButtonText:"关闭"})}else{toastr.warning('系统服务异常，请稍后再试!')}},1000)}function successRemoteResponse(response){if(response.close!==undefined&&response.close){var that=this;setTimeout(function(){that.hide();if(response.code=='0'){setTimeout(function(){if(localStorage.getItem("show-message")=='1'){swal({title:"操作成功",text:response.message,type:"success",confirmButtonColor:localStorage.getItem("s-skin-color"),confirmButtonText:"关闭"})}else{toastr.success('操作成功，'+response.message)}setTimeout(function(){$.pjax.reload({container:'#crud-datatable-pjax'})},2000)},100)}else{setTimeout(function(){if(localStorage.getItem("show-message")=='1'){swal({title:"操作失败",text:response.message,type:"error",confirmButtonColor:localStorage.getItem("s-skin-color"),confirmButtonText:"关闭"})}else{toastr.error('操作失败，'+response.message)}},100)}},500);return}if(response.size!==undefined)this.setSize(response.size);if(response.title!==undefined)this.setTitle(response.title);if(response.content!==undefined)this.setContent(response.content);if(response.footer!==undefined){this.setFooter(response.footer)}else{this.setFooter('<button type="button" class="btn btn-white" data-dismiss="modal">取  消</button><button type="submit" class="btn btn-primary">确  认</button>')}if($(this.content).find("form")[0]!==undefined){this.setupFormSubmit($(this.content).find("form")[0],$(this.footer).find('[type="submit"]')[0])}}this.setupFormSubmit=function(modalForm,modalFormSubmitBtn){if(modalFormSubmitBtn===undefined){console.warn('Modal has form but does not have a submit button')}else{var instance=this;$(modalFormSubmitBtn).click(function(e){var data;if(window.FormData){data=new FormData($(modalForm)[0])}else{data=$(modalForm).serializeArray()}instance.doRemote($(modalForm).attr('action'),$(modalForm).hasAttr('method')?$(modalForm).attr('method'):'GET',data)})}};this.confirmModal=function(title,message,okLabel,cancelLabel,size,dataUrl,dataRequestMethod,selectedIds){this.show();this.setSize(size);if(title!==undefined){this.setTitle(title)}this.setContent('<form id="ModalRemoteConfirmForm">'+message);var instance=this;this.addFooterButton(okLabel===undefined?this.defaults.okLabel:okLabel,'submit','btn btn-primary',function(e){var data;if(window.FormData){data=new FormData($('#ModalRemoteConfirmForm')[0]);if(typeof selectedIds!=='undefined'&&selectedIds)data.append('pks',selectedIds.join())}else{data=$('#ModalRemoteConfirmForm');if(typeof selectedIds!=='undefined'&&selectedIds)data.pks=selectedIds;data=data.serializeArray()}console.log(data);instance.doRemote(dataUrl,dataRequestMethod,data)});this.addFooterButton(cancelLabel===undefined?this.defaults.cancelLabel:cancelLabel,'button','btn btn-default',function(e){this.hide()})}this.open=function(elm,ids,rowData){console.log(ids,rowData);if($(elm).hasAttr('data-confirm-title')||$(elm).hasAttr('data-confirm-message')){this.confirmModal($(elm).attr('data-confirm-title'),$(elm).attr('data-confirm-message'),$(elm).attr('data-confirm-ok'),$(elm).attr('data-confirm-cancel'),$(elm).hasAttr('data-modal-size')?$(elm).attr('data-modal-size'):'normal',$(elm).hasAttr('href')?$(elm).attr('href'):$(elm).attr('data-url'),$(elm).hasAttr('data-request-method')?$(elm).attr('data-request-method'):'GET',ids)}else{if($(elm).attr('data-get-field')){ids=$(elm).attr('data-get-field')+'='+ids}this.doRemote($(elm).hasAttr('href')?$(elm).attr('href'):$(elm).attr('data-url'),$(elm).hasAttr('data-request-method')?$(elm).attr('data-request-method'):'GET',ids)}}}